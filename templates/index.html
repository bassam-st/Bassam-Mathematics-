<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ุจุณุงู ูุงุซ โ Bassam Mathematics Pro</title>

  <!-- PWA -->
  <link rel="manifest" href="/static/pwa/manifest.json">
  <meta name="theme-color" content="#0b0f19"/>

  <!-- CSS -->
  <link rel="stylesheet" href="/static/style.css"/>

  <!-- Tesseract.js ููู OCR (ูุชุตูุญ ููุท) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    /* ุชุญุณููุงุช ุจุณูุทุฉ ููู style.css */
    .kbd {display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-top:12px}
    .kbd button{padding:12px;border:none;border-radius:10px;background:#2a2f45;color:#fff;font-weight:600}
    .kbd button:hover{background:#353c59}
    .kbd .primary{background:#7c5cff;color:#111}
    .kbd .danger{background:#ff4d6d}
    .row{display:flex;gap:8px;align-items:center}
    .row>*{flex:1}
    textarea#q{width:100%;min-height:58px;resize:vertical}
    .card{max-width:820px}
    .hidden{display:none}
    #ocrBox{display:flex;gap:10px;align-items:center;margin-top:8px}
    #ocrPreview{width:64px;height:64px;border-radius:10px;object-fit:cover;border:1px solid #2a3250;background:#141a2a}
    #ocrStatus{font-size:.95rem;color:#bfc6da}
  </style>
</head>
<body>
<header class="top">
  <h1>๐ง ุจุณุงู ูุงุซ โ ุญูู ุชูุตููู ููู ุงููุณุงุฆู</h1>
</header>

<section class="card">
  <textarea id="q" placeholder="ุงูุชุจ ุงููุณุฃูุฉ ููุงโฆ ูุซู: 3*(2-6)/(12+8) ุฃู ูุดุชู x^3*sin(x)"></textarea>

  <div class="row">
    <select id="mode">
      <option value="auto">ุชููุงุฆู</option>
      <option value="evaluate">ุญุณุงุจ ุนุงุฏู</option>
      <option value="derivative">ุชูุงุถู</option>
      <option value="integral">ุชูุงูู</option>
      <option value="solve">ูุนุงุฏูุงุช</option>
      <option value="matrix">ูุตูููุงุช</option>
    </select>
    <button id="solveBtn" class="primary">ุญู ๐งฎ</button>
  </div>

  <!-- ูุงููุฑุง + OCR -->
  <div id="ocrBox">
    <input id="imgInput" type="file" accept="image/*" capture="environment" class="hidden">
    <button id="cameraBtn">๐ท ุตูุฑุฉ ูุณุฃูุฉ</button>
    <img id="ocrPreview" class="hidden" alt="preview">
    <div id="ocrStatus"></div>
  </div>

  <!-- ููุญุฉ ุงูููุงุชูุญ ุงูุฑูุงุถูุฉ -->
  <div class="kbd" id="kbd">
    <!-- ุตู 1 -->
    <button data-k="7">7</button>
    <button data-k="8">8</button>
    <button data-k="9">9</button>
    <button data-k="/">รท</button>
    <button data-k="*">ร</button>
    <button data-k="^">x^y</button>

    <!-- ุตู 2 -->
    <button data-k="4">4</button>
    <button data-k="5">5</button>
    <button data-k="6">6</button>
    <button data-k="+">+</button>
    <button data-k="-">โ</button>
    <button data-k="(">(</button>

    <!-- ุตู 3 -->
    <button data-k="1">1</button>
    <button data-k="2">2</button>
    <button data-k="3">3</button>
    <button data-k=")">)</button>
    <button data-k=".">.</button>
    <button id="bksp" class="danger">โซ</button>

    <!-- ุตู 4 -->
    <button data-k="0">0</button>
    <button data-k="x">x</button>
    <button data-k="y">y</button>
    <button data-k="z">z</button>
    <button data-k="pi">ฯ</button>
    <button data-k="E">e</button>

    <!-- ุตู 5 -->
    <button data-t="sin">sin( )</button>
    <button data-t="cos">cos( )</button>
    <button data-t="tan">tan( )</button>
    <button data-t="log">log( )</button>
    <button data-t="ln">ln( )</button>
    <button data-t="sqrt">โ( )</button>

    <!-- ุตู 6 -->
    <button id="pow2">xยฒ</button>
    <button id="abs">|x|</button>
    <button id="frac">a/b</button>
    <button id="ddx">d/dx</button>
    <button id="intg">โซ</button>
    <button id="mat">Mat</button>

    <!-- ุตู 7 -->
    <button id="eq">=</button>
    <button id="comma">,</button>
    <button id="semi">;</button>
    <button id="lbrack">[</button>
    <button id="rbrack">]</button>
    <button id="clr" class="danger">CLR</button>
  </div>

  <div class="row" style="margin-top:10px">
    <button id="example1">ูุซุงู ุญุณุงุจ</button>
    <button id="example2">ูุซุงู ุชูุงุถู</button>
    <button id="example3">ูุซุงู ูุธุงู</button>
  </div>

  <details class="help">
    <summary><strong>ุฏููู ุงูุงุณุชุฎุฏุงู ุงูุณุฑูุน (ุงุถุบุท ูููุชุญ/ุงูุฅุบูุงู)</strong></summary>
    <div class="help-grid">
      <h4>ูก) ููู ุฃูุชุจ ุงููุณุฃูุฉุ</h4>
      <ul>
        <li>ุงูุนูููุงุช: <code>2+3*(4-1)</code>ุ ุงููุณูุฑ: <code>3/4</code>ุ ุงูุฃุณุณ: <code>x^2</code> ุฃู <code>x**2</code></li>
        <li>ุงูุฌุฐุฑ: <code>sqrt(x)</code>ุ ุงูุฏูุงู: <code>sin(x)</code>ุ <code>cos(x)</code>ุ <code>log(x)</code>ุ <code>exp(x)</code></li>
        <li>ุงูุชูุงุถู: ุงุฎุชุฑ ุงููุถุน <b>ุชูุงุถู</b> ุฃู ุงูุชุจ <code>ูุดุชู f(x)</code></li>
        <li>ุงูุชูุงูู: ุงุฎุชุฑ ุงููุถุน <b>ุชูุงูู</b> ุฃู ุงูุชุจ <code>ุชูุงูู f(x)</code></li>
        <li>ุงููุนุงุฏูุงุช: ูุซุงู: <code>x^2 - 5*x + 6 = 0</code></li>
        <li>ูุธุงู ูุนุงุฏูุงุช (ุงูุตู ุจู ;): <code>x+y=1; 2*x-3*y=5</code></li>
        <li>ูุตูููุงุช: <code>det([[1,2],[3,4]])</code>ุ <code>inv([[1,2],[3,4]])</code>ุ <code>rref([[...]]</code>)</li>
        <li>ูู ุงููุงููุฑุง: ุงุถุบุท <b>๐ท ุตูุฑุฉ ูุณุฃูุฉ</b> ุซู ุชุฃูุฏ ูู ุชุตุญูุญ ุงูุฑููุฒ ุฅู ูุฒู (ร โ <code>*</code> ุ รท โ <code>/</code> ุ โ โ <code>sqrt</code> โฆ).</li>
      </ul>
    </div>
  </details>
</section>

<section id="steps" class="card" style="margin-top:14px"></section>
<section id="result" class="card" style="margin-top:14px"></section>

<script>
  // ุชุณุฌูู Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/static/pwa/sw.js').catch(()=>{});
  }

  const $ = s => document.querySelector(s);
  const q = $("#q");
  const modeSel = $("#mode");
  const solveBtn = $("#solveBtn");
  const stepsDiv = $("#steps");
  const resultDiv = $("#result");

  async function postJSON(url, data){
    const r = await fetch(url, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(data)
    });
    return r.json();
  }

  function insert(text){
    const start = q.selectionStart ?? q.value.length;
    const end = q.selectionEnd ?? q.value.length;
    const before = q.value.slice(0,start);
    const after = q.value.slice(end);
    q.value = before + text + after;
    const pos = start + text.length;
    q.focus();
    q.setSelectionRange(pos,pos);
  }

  // ููุญุฉ ุงูููุงุชูุญ
  document.getElementById("kbd").addEventListener("click", (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    if(btn.dataset.k){ insert(btn.dataset.k); return; }

    switch(btn.id){
      case "bksp": {
        const s = q.selectionStart ?? q.value.length;
        if(s>0){
          q.value = q.value.slice(0,s-1) + q.value.slice(q.selectionEnd ?? s);
          q.setSelectionRange(s-1, s-1);
        }
        q.focus(); break;
      }
      case "clr":  q.value=""; q.focus(); break;
      case "pow2": insert("^2"); break;
      case "abs":  insert("|x|"); break;
      case "frac": insert("a/b"); break;
      case "ddx":  modeSel.value="derivative"; break;
      case "intg": modeSel.value="integral"; break;
      case "mat":  insert("[[1,2],[3,4]]"); modeSel.value="matrix"; break;
      case "eq":   insert(" = "); break;
      case "comma": insert(","); break;
      case "semi": insert("; "); break;
      case "lbrack": insert("["); break;
      case "rbrack": insert("]"); break;
    }
  });

  // ููุงูุจ ุงูุฏูุงู sin/...
  document.querySelectorAll('[data-t]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const f = btn.dataset.t;
      insert(f + "()");
      const pos = (q.selectionStart ?? q.value.length) - 1;
      q.setSelectionRange(pos,pos);
      q.focus();
    });
  });

  // ุฃูุซูุฉ
  $("#example1").onclick = ()=>{ q.value="3*(2-6)/(12+8)"; modeSel.value="evaluate"; };
  $("#example2").onclick = ()=>{ q.value="x^3*sin(x)";    modeSel.value="derivative"; };
  $("#example3").onclick = ()=>{ q.value="x+y=1; 2*x-3*y=5"; modeSel.value="solve"; };

  // ุชูููุฐ ุงูุญู
  solveBtn.onclick = async ()=>{
    const query = q.value.trim();
    if(!query){ return; }
    stepsDiv.innerHTML = "<p>โณ ุฌุงุฑู ุงูุญูโฆ</p>";
    resultDiv.innerHTML = "";
    try{
      const data = await postJSON("/solve", { q: query, mode: modeSel.value });
      if(!data.ok){
        stepsDiv.innerHTML = `<p style="color:#ff6b6b">โ ${data.error}</p>`;
        return;
      }
      let html = "";
      (data.steps||[]).forEach(s=>{
        html += `<div class="step"><b>${s.title}:</b><br>${s.content}</div>`;
      });
      stepsDiv.innerHTML = html || "<p>ูุง ุชูุฌุฏ ุฎุทูุงุช.</p>";
      resultDiv.innerHTML = `<h3>ุงููุชูุฌุฉ:</h3><p style="font-size:1.1rem">${data.result}</p>`;
    }catch(err){
      stepsDiv.innerHTML = `<p style="color:#ff6b6b">โ ${err}</p>`;
    }
  };
  q.addEventListener("keydown",(e)=>{
    if(e.key==="Enter" && (e.metaKey||e.ctrlKey||!e.shiftKey)){ e.preventDefault(); solveBtn.click(); }
  });

  // --------- ๐ท ุงููุงููุฑุง + OCR ----------
  const cameraBtn = $("#cameraBtn");
  const imgInput  = $("#imgInput");
  const ocrPrev   = $("#ocrPreview");
  const ocrStatus = $("#ocrStatus");

  cameraBtn.onclick = ()=> imgInput.click();

  imgInput.onchange = async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;

    // ุนุฑุถ ุงููุนุงููุฉ
    ocrPrev.src = URL.createObjectURL(file);
    ocrPrev.classList.remove("hidden");

    // ุชุดุบูู OCR
    ocrStatus.textContent = "๐ ูุฑุงุกุฉ ุงููุต ูู ุงูุตูุฑุฉโฆ";
    try{
      const res = await Tesseract.recognize(file, 'eng', {
        logger: m => {
          if(m.status === 'recognizing text'){
            ocrStatus.textContent = `๐ ุงูุชุนุฑู: ${Math.round(m.progress*100)}%`;
          }
        }
      });
      let text = (res.data.text || "").trim();
      text = normalizeOcr(text);
      // ุฃุฏุฑุฌ ุงููุต ูู ูุฑุจุน ุงููุณุฃูุฉ ูุดุบูู ุงูุญู ุชููุงุฆููุง
      q.value = text;
      ocrStatus.textContent = "โ ุชู ุงูุชูุงุท ุงููุต. ุงุถุบุท ุญู ุฃู ุณูุชู ุงูุญู ุชููุงุฆููุงโฆ";
      setTimeout(()=>solveBtn.click(), 300);
    }catch(err){
      ocrStatus.textContent = "โ ูุดู ุงูุชุนุฑู ุนูู ุงููุต";
      console.error(err);
    }
  };

  // ุชูุธูู ูุชุญููู ูุต ุงููOCR ุฅูู ุตูุบุฉ ุฑูุงุถูุฉ ููุงุณุจุฉ ูู SymPy
  function normalizeOcr(t){
    // ุชูุญูุฏ ุงูุฃุฑูุงู ุงูุนุฑุจูุฉ/ุงูุฑููุฒ
    const arabicNums = 'ููกูขูฃูคูฅูฆูงูจูฉ';
    const latinNums  = '0123456789';
    for(let i=0;i<10;i++){
      t = t.replaceAll(arabicNums[i], latinNums[i]);
    }
    return t
      .replace(/[รxX] ?(?=\d|\w)/g, '*')      // ร ุฃู x ูุถุฑุจ (ุชูุฑูุจูุฉ)
      .replace(/รท/g, '/')
      .replace(/โ|โ/g, '-')
      .replace(/โ/g, 'sqrt')
      .replace(/ฯ/g, 'pi')
      .replace(/ุ/g, ',')
      .replace(/\s*=\s*/g, ' = ')
      .replace(/[^\S\r\n]+/g, ' ')            // ูุณุงูุงุช ุฒุงุฆุฏุฉ
      .replace(/\s*\n+\s*/g, '; ')            // ุฃุณุทุฑ ุฌุฏูุฏุฉ โ ูุธุงู ูุนุงุฏูุงุช
      .replace(/\s*\)\s*/g, ')')
      .replace(/\s*\(\s*/g, '(')
      .trim();
  }
</script>

</body>
</html>
